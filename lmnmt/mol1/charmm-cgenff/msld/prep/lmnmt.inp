* CHARMM input file for Multi-Site lambda-dynamics
* generated by py_prep (JZV 02/2019) for ALF (RLH 01/2019)
* edited: Parveen Gartan, 27 June 2022
*
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!  Lambda Dynamics 
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

set fnex = 5.5 
set builddir = prep
set box = 92.1673522
set temp = 298.15

! perturbation variables
set nsites = 1 
set nsubs1 = 2 
set nblocks = 2 

bomblev -2

!! Read in toppar stream file
stream @builddir/toppar.str

stream @builddir/5ag5_cof_rg.str

stream @builddir/6.str
stream @builddir/6r.str

read psf card name @builddir/5ag5_prot-6-neutralized.psf
read coor card name @builddir/5ag5_prot-6-prod-oriented.crd

read psf card name @builddir/6r.psf append
read coor card name @builddir/6r.crd append 

!! Read in LonePair sites (if applicable)
stream @builddir/lpsites.inp

!! Define MSLD substituent selections
define site1_sub1 select resname XRAY end
define site1_sub2 select resname REVR end

!auto angle dihe  !! do not call after deleting sub-sub terms or loading in water
bomblev -1

! delete angles and dihedrals between alchem groups
set ii = 1
label deletesiteloop
if @ii .le. @nsites then

   set jj = 1
   label delete1loop
   if @jj .le. @nsubs@@ii then

      calc kk = @jj + 1
      label delete2loop
      if @kk .le. @nsubs@@ii then

         dele connectivity sele ( site@{ii}_sub@@jj ) show end sele ( site@{ii}_sub@@kk ) show end
         calc kk = @kk + 1
         goto delete2loop
      endif

      calc jj = @jj + 1
      goto delete1loop
   endif

   calc ii = @ii + 1
   goto deletesiteloop
endif

!! ! System specific deletion (linear groups)
!! dele dihe sele (atom LIG 1 ATOMNAME) show end

!! Load solvent

!! Load ions

print coor sele .not. init end

bomblev 0

crystal define cubic @box @box @box 90. 90. 90.
crystal build cutoff 14 nope 0
image byres xcen 0 ycen 0 zcen 0 sele resn tip3 .or. resn pot .or. resn cla end
image byseg xcen 0 ycen 0 zcen 0 sele .not. ( resn tip3 .or. resn pot .or. resn cla ) end

scalar charge stat sele all end

!! Copy main coords into comp set
cons harm clear
coor copy comp

! LDBI math: for every "pair" there are 5 ldbi's
set ii = 1
set ldbibias = 0
label ldbimathloop
if @ii .le. @nsites then
   calc ldbibias = @ldbibias + ( ( @nsubs@@ii * (@nsubs@@ii - 1) / 2 ) * 5 )
   INCR ii by 1
   goto ldbimathloop
endif
set charge = ?cgtot

calc blockplusone = @nblocks + 1

!! BLOCK setup
BLOCK @blockplusone
   clear
END
BLOCK @blockplusone !RX NREP @nreps
   Call 2 sele site1_sub1 show end
   Call 3 sele site1_sub2 show end

   qldm theta
   lang temp @temp
   !phmd 7
   soft on   ! this turns on soft-cores
   pmel ex   ! this turns on PME

   ldin 1 1.0  0.0  5.0  0.0  5.0 !FIX 7.0
   ldin 2  0.5000 0.0  5.0  @lams1s1 5.0 !FIX 7.0
   ldin 3  0.5000 0.0  5.0  @lams1s2 5.0 !FIX 7.0

   set excl1 = 2 3 
   excl @excl1

   !rmla bond thet dihe impr 
   rmla bond thet impr 
   msld 0  1  1 fnex @fnex
   msma

   ! Check block.doc for functional form of these biasing potentials
   calc nbiaspot = 5 * ( @nblocks * ( @nblocks - 1 ) ) / 2
   ldbi @nbiaspot
   set ibias = 1
   set iblock = 0
   set si = 1
   label loop5_vb
   if @si .le. @nsites then
      set jblock = @iblock
      set sj = @si
      label loop5b_vb
      if @sj .le. @nsites then
         set ii = 1
         label loop6_vb
         if @ii .le. @nsubs@@{si} then
            calc ip1 = @ii + 1 + @iblock
            set jj = 1
            if @si .eq. @sj then
               calc jj = @ii + 1
            endif
            label loop7_vb
            if @jj .le. @nsubs@@{sj} then
               calc jp1 = @jj + 1 + @jblock
   
               set c_shift = 0.0
               set x_shift = 0.0
               set s_shift = 0.0
               !vbrex! if @si .eq. @sj then
               !vbrex!    calc c_shift = 1.2 * (@myrep - @ncentral)
               !vbrex!    calc s_shift = 0.3 * (@myrep - @ncentral)
               !vbrex! endif
   
               calc coeff = @cs@@{si}s@@{ii}s@@{sj}s@@{jj} + @{c_shift}
               ldbv @ibias @ip1 @jp1 6 0.0 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @xs@@{si}s@@{ii}s@@{sj}s@@{jj} + @{x_shift}
               ldbv @ibias @ip1 @jp1 10 -5.56 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @ss@@{si}s@@{ii}s@@{sj}s@@{jj} + @{s_shift}
               ldbv @ibias @ip1 @jp1 8 0.017 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @xs@@{sj}s@@{jj}s@@{si}s@@{ii} + @{x_shift}
               ldbv @ibias @jp1 @ip1 10 -5.56 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @ss@@{sj}s@@{jj}s@@{si}s@@{ii} + @{s_shift}
               ldbv @ibias @jp1 @ip1 8 0.017 @coeff 0
               calc ibias = @ibias + 1
               calc jj = @jj + 1
               goto loop7_vb
            endif
            calc ii = @ii + 1
            goto loop6_vb
         endif
         calc jblock = @jblock + @nsubs@@{sj}
         calc sj = @sj + 1
         goto loop5b_vb
      endif
      calc iblock = @iblock + @nsubs@@{si}
      calc si = @si + 1
      goto loop5_vb
   endif
END


!! !! Set NOE distance restraints
NOE
   RESET
END

faster on

energy

stream @builddir/noe_xray.str"
stream @builddir/noe_revr.str"


